name: Build Custom GeoIP

on:
  workflow_dispatch:  # Ручной запуск
  schedule:
    - cron: "0 3 * * 3" # Раз в неделю

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Tools
        run: |
          # Собираем v2dat из исходников (самый надежный способ)
          go install github.com/urlesistiana/v2dat@latest
          
          # Качаем официальный geoip.dat
          wget https://github.com/v2fly/geoip/releases/latest/download/geoip.dat -O geoip.dat

      - name: Unpack GeoIP
        run: |
          # v2dat теперь установлен в систему, используем его
          v2dat unpack geoip.dat -o ./data

      - name: Filter Countries (Clean up)
        shell: pwsh
        run: |
          # === ЧТО ОСТАВЛЯЕМ ===
          $KeepList = @(
              "ru", "cn", "ir"
              "private"
          )
          
          # === ОЧИСТКА ===
          Set-Location ./data
          $CountBefore = (Get-ChildItem).Count
          
          # Удаляем лишнее
          Get-ChildItem -File | Where-Object { $KeepList -notcontains $_.Name } | Remove-Item -Force
          
          $CountAfter = (Get-ChildItem).Count
          Write-Host "Было файлов: $CountBefore"
          Write-Host "Осталось файлов: $CountAfter"

      - name: Pack Custom GeoIP
        run: |
          # Собираем обратно
          v2dat pack -o geoip-custom.dat ./data

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: geoip.dat
          path: geoip-custom.dat

      - name: Release
        uses: softprops/action-gh-release@v1
        if: github.event_name != 'pull_request'
        with:
          tag_name: latest
          files: geoip-custom.dat
          prerelease: false