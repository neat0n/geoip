name: Build Custom GeoIP

on:
  workflow_dispatch:  # Кнопка ручного запуска
  schedule:
    - cron: "0 3 * * 3" # Автозапуск раз в неделю (в среду в 3 утра)

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download Tools & Data
        run: |
          # 1. Качаем утилиту v2dat (для распаковки/упаковки)
          wget https://github.com/urlesistiana/v2dat/releases/download/v0.0.6/v2dat_linux_amd64 -O v2dat
          chmod +x v2dat
          
          # 2. Качаем официальный полный geoip.dat
          wget https://github.com/v2fly/geoip/releases/latest/download/geoip.dat -O geoip.dat

      - name: Unpack GeoIP
        run: |
          # Распаковываем базу в папку data
          ./v2dat unpack geoip.dat -o ./data

      - name: Filter Countries (Clean up)
        shell: pwsh
        run: |
          # === НАСТРОЙКИ: ЧТО ОСТАВЛЯЕМ ===
          $KeepList = @(
              "ru", "cn", "ir",
              "private"
          )
          
          # === МАГИЯ ОЧИСТКИ ===
          Set-Location ./data
          $CountBefore = (Get-ChildItem).Count
          
          # Удаляем всё, чего нет в списке
          Get-ChildItem -File | Where-Object { $KeepList -notcontains $_.Name } | Remove-Item -Force
          
          $CountAfter = (Get-ChildItem).Count
          Write-Host "Было файлов: $CountBefore"
          Write-Host "Осталось файлов: $CountAfter"

      - name: Pack Custom GeoIP
        run: |
          # Собираем обратно
          ./v2dat pack -o geoip-custom.dat ./data

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: geoip.dat
          path: geoip-custom.dat

      - name: Release
        uses: softprops/action-gh-release@v1
        if: github.event_name != 'pull_request'
        with:
          tag_name: latest
          files: geoip-custom.dat
          prerelease: false